# **Key Management** #

    By Gavin Ye
    8/8/2017



## Table of Content

- [Table of Content](#table-of-content)
- [1. Overview](#1-overview)
    - [1.1 Client Key and Id](#11-client-key-and-id)
        - [1.1.1 Certificate](#111-certificate)
        - [1.1.2 Client Key](#112-client-key)
        - [1.1.3 Client Id](#113-client-id)
    - [1.2 File Token](#12-token)
- [2. Client Key](#2-client-key)
    - [2.1 Generate Certificate](#21-generate-certificate)
        - [2.1.1 User Certificate](#211-user-certificate)
        - [2.1.2 Machine Certificate](#212-machine-certificate)
    - [2.2 Generate key and Id](#22-generate-key-and-id)
- [3. File Token](#2-file-token)
    - [3.1 Algorithm](#31-algorithm)
    - [3.2 Generate](#32-generate)
    - [3.3 Retrieve](#33-retrieve)
    - [3.4 Cache](#34-cache)



## 1. Overview

There are two kind of keys are used by RMC:

- Client Key
- File Token

### 1.1 Client Key and Id

Client key is used to protect RMC local data (configuration, cached data, etc.). Client id is an unique id for the client installed on this machine.

#### 1.1.1 Certificate

The certificate is generated by RMC installer and stored in user's or machine's certificate store. It is used to generate client key and id.

#### 1.1.2 Client Key

The client key is an AES 256 key generated from client certificate.
See `"keym.h & keym.cpp"` in `"librmc"`.

#### 1.1.2 Client Id

The client id is HMAC MD5 hash data generated from client certificate.
See `"keym.h & keym.cpp"` in `"librmc"`.

### 1.2 File Token

File token is an AES 256 key encrypt key (KEK) generated by KMS (Key Management Server) which is used to encrypt file content encrypt key (CEK).

## 2. Client Key

### 2.1 Generate Certificate

Client Certificate is generated by installer when user install the software.

### 2.1.1 User Certificate

If user choose to install the software only for current user, installer will generate a certificate contains RSA key pair in current user's certificate store.

### 2.1.2 Machine Certificate

If user choose to install the software for all users, installer will generate a certificate contains RSA key pair in machine's certificate store.

### 2.2 Generate Key and Id

LibRMC provides class and API to generate client id and client key.
See `"keym.h & keym.cpp"` in `"librmc"`.

## 3. File Token

### 3.1 Algorithm

RMC use AES CBC mode to encrypt key and data.

### 3.2 Generate

KMS is responsible for generating file token. Client use RESTful API call to request KMS generate tokens.

See:

[Token REST API](https://bitbucket.org/nxtlbs-devops/rightsmanagement-wiki/wiki/RMS/RESTful%20API/Token%20REST%20API)

And

`"rest_token.cpp"` in `"librmc"`.

### 3.3 Retrieve

KClient use RESTful API call to retrieve an existing file token by sending its token id to KMS.

See:

[Token REST API](https://bitbucket.org/nxtlbs-devops/rightsmanagement-wiki/wiki/RMS/RESTful%20API/Token%20REST%20API)

And

`"rest_token.cpp"` in `"librmc"`.


```cpp
Result RmSession::ReadLocalFileTokenFromServer(const std::wstring& ownerId,
                                               const std::wstring& agreement,
                                               _Inout_ NX::NXL::FileToken& token);
```

### 3.4 Cache

If a file is on NTFS volume, RMC caches its file token in its alternate data stream (ADS).

See `"session_localfile.cpp"` in `"librmc"`.

```cpp
Result RmSession::ReadCachedLocalFileToken(const std::wstring& path,
                                        const std::wstring& ownerId,
                                        const std::wstring& duid,
                                        _Inout_ NX::NXL::FileToken& token);

Result RmSession::WriteCachedLocalFileToken(const std::wstring& path,
                                        const std::wstring& ownerId,
                                        const std::wstring& duid,
                                        const NX::NXL::FileToken& token);
```